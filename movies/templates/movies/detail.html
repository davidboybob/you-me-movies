{% extends 'movies/base.html' %}
{% load bootstrap4%}

{% block content %}
  <h1>DETAIL</h1>
  <hr>
  <img class="w-25" src="https://image.tmdb.org/t/p/w600_and_h900_bestv2{{ movie.poster_path }}" alt="poster">
  <p>{{ movie.title }}</p>
  {% for genres in movie.genre.all %}
    <p>{{ genres }}</p>
  {% endfor %}
  <p>{{ movie.audience }}</p>
  <p>{{ movie.description }}</p>
  <hr>
  
  {% if user in movie.like_users.all %}
    <i class="fas fa-heart like-button" style="color: crimson;" data-id="{{ movie.pk }}"></i>
  {% else %}
    <i class="fas fa-heart like-button"style="color: black;" data-id="{{ movie.pk }}"></i>
  {% endif %}
  <span id="like-count-{{ movie.pk }}">{{ movie.like_users.all|length }}</span>명이 이 글을 좋아합니다.
  {% for review in reviews %}
    <div>
      내용 : {{ review.content }} |
      평점 : {{ review.score }} |
      작성자 : <a href="{% url 'accounts:profile' review.user %}">{{ review.user }}</a>

      {% if request.user == review.user %}
        <form action="{% url 'movies:delete' movie.id review.id %}" method="POST">
          {% csrf_token %}
          <input type="submit" value="Delete">
        </form>
      {% endif %}
    
    </div>
  {% endfor %}


  {% if user.is_authenticated %}
  <form action="{% url 'movies:new' movie.id %}" method="POST">
    {% csrf_token %}
    {{ review_form }}
    <input type="submit" value="submit">
  </form>
  {% else %}
    <a href="#login"> [리뷰를 남기려면, 로그인하세요]</a>
  {% endif %}
  <hr>
  <a href="{% url 'movies:index' %}">[BACK]</a>
{% endblock content %}


<script>
  // 1. 각 게시글 별로 좋아요 버튼이 있으니, 모두 선택해야 한다.
  const likebuttons = document.querySelectorAll('.like-button')
  // 2. for Each 를 사용해서 각각의 좋아요 버튼을 클릭
  likebuttons.forEach(button => {
    button.addEventListener('click', function (event) {
      console.log(event)
      // event.taget.dataset.id 의 value 는 data-id 값이 들어 있다.
      const movieId = event.target.dataset.id
      // 해당 상세 게시글의 좋아요 요청을 보낸다.
      axios.defaults.headers.common['X-Requested-With'] = 'XMLHttpRequest'
      axios.defaults.xsrfCookieName = 'csrftoken'
      axios.defaults.xsrfHeaderName = 'X-CSRFToken'
      axios.post(`/movies/${movieId}/like/`)
        .then(response => {
          console.log(response)
          document.querySelector(`#like-count-${movieId}`).innerText = response.data.count
          if (response.data.liked) {
            // True이면 , 누르게 된것 => 좋아요 색깔을 빨갛게
            event.target.style.color = 'crimson'
          } else {
            //좋아요 색깔을 까맣게
            event.target.style.color = 'black'
          }
        })
        .catch(error => console.log(error))
    })
  })
</script>